#!/usr/bin/env bash
set -e -x

if [[ $CI ]]; then
  bin/rspec --format documentation
else
  bin/rspec
fi

# load seed data in test env (make sure db seeds work)
cp db/schema.rb tmp/tmp-schema.rb
bin/rails db:environment:set RAILS_ENV=test
RAILS_ENV=test bundle exec rake db:migrate VERSION=0               # migrate down
RAILS_ENV=test bundle exec rake db:migrate                         # migrate up
RAILS_ENV=test ALLOW_SEED_DATA=true SEED_DATA_USERS=3 bundle exec rake db:setup
cp tmp/tmp-schema.rb db/schema.rb
bundle exec rake db:test:prepare
if [ -z $CI ]; then
  bin/rails db:environment:set RAILS_ENV=development
fi

rubocop --auto-correct --display-cop-names --fail-level autocorrect

brakeman --exit-on-warn --quiet
